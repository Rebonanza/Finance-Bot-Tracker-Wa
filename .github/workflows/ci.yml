name: ğŸš€ Deploy WhatsApp Finance Bot to Railway

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ§ª Run message parser tests
        run: |
          python test_parser.py

      - name: âœ… Test completed
        run: echo "All tests passed! ğŸ‰"

  deploy:
    name: ğŸš€ Deploy to Railway
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš„ Deploy to Railway
        uses: railway/deploy-action@v1.0.0
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          railway_project: ${{ secrets.RAILWAY_PROJECT_ID }}
          railway_service: ${{ secrets.RAILWAY_SERVICE_ID }}

      - name: ğŸ‰ Deployment completed
        run: |
          echo "ğŸš€ WhatsApp Finance Bot deployed successfully!"
          echo "ğŸ“± Bot is now live on Railway"
          echo "ğŸ”— Update your Twilio webhook URL if needed"

  notify:
    name: ğŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()
    
    steps:
      - name: ğŸ“Š Report Status
        run: |
          if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… SUCCESS: WhatsApp Finance Bot deployed successfully!"
            echo "ğŸ¯ Your family bot is now live and ready to use"
          elif [ "${{ needs.test.result }}" == "failure" ]; then
            echo "âŒ FAILED: Tests failed - deployment skipped"
          elif [ "${{ needs.deploy.result }}" == "failure" ]; then
            echo "âŒ FAILED: Deployment failed"
          else
            echo "â¸ï¸ SKIPPED: Deployment skipped (not main branch)"
          fi