name: 🚀 Deploy WhatsApp Finance Bot to Railway

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    name: 🧪 Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🧪 Run message parser tests
        run: |
          python test_parser.py

      - name: ✅ Test completed
        run: echo "All tests passed! 🎉"

  deploy:
    name: 🚀 Deploy to Railway
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🚄 Deploy to Railway
        uses: railway/deploy-action@v1.0.0
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          railway_project: ${{ secrets.RAILWAY_PROJECT_ID }}
          railway_service: ${{ secrets.RAILWAY_SERVICE_ID }}

      - name: 🎉 Deployment completed
        run: |
          echo "🚀 WhatsApp Finance Bot deployed successfully!"
          echo "📱 Bot is now live on Railway"
          echo "🔗 Update your Twilio webhook URL if needed"

  notify:
    name: 📢 Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()
    
    steps:
      - name: 📊 Report Status
        run: |
          if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "✅ SUCCESS: WhatsApp Finance Bot deployed successfully!"
            echo "🎯 Your family bot is now live and ready to use"
          elif [ "${{ needs.test.result }}" == "failure" ]; then
            echo "❌ FAILED: Tests failed - deployment skipped"
          elif [ "${{ needs.deploy.result }}" == "failure" ]; then
            echo "❌ FAILED: Deployment failed"
          else
            echo "⏸️ SKIPPED: Deployment skipped (not main branch)"
          fi